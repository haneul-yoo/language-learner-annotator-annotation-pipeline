{% extends "base.html" %}
{% block body %}
<div id="task-view">
    <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <div class="navbar-item">
                <a href="/" class="has-text-white">Language Learner Annotation - Annotation Pipeline</a>
            </div>
        </div>
        <div class="navbar-menu">
            <div class="navbar-start">
                <div class="navbar-item">
                    Page [[ contextIndex + 1 ]] / [[ contexts.length ]]
                </div>
            </div>
        </div>
    </nav>
    <div v-if="!contexts || !contexts.length">
        There are no more questions left in this language / task pair.<br/>Please select other options and try again.
    </div>
    <div class="container v-large-padded h-padded">
        <div class="content">
            <template v-for="(context, i) of contexts" v-if="i === contextIndex" >
                <div>
                    <div>
                        <div v-if="context.task === 'machine reading comprehension'" class="columns">
                            <div class="column is-two-thirds">
                                <h4>Sentence</h4>
                                <div>
                                    <p>
                                        <b>context</b>
                                        <div id="mrc" ref="target" @select="selectAnswerspan" disabled style="border:2px solid turquoise;">[[JSON.parse(context.sentence).context]]</div>
                                    </p>
                                    <p>
                                        <b>question</b>
                                        [[JSON.parse(context.sentence).question]]
                                    </p>
                                </div>
                                <hr/>
                                <div v-if="isTranslation == 'tran'">
                                    <div v-for="(value, key) of JSON.parse(context.sentence_trans)">
                                        <p>
                                            <b>[[key]]</b>
                                            [[value]]
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <h4>Question</h4>
                                <div v-for="question in questions">
                                    [[question.text]]
                                    <div v-if="context.id in response && response[context.id]['answerstart'] && !response[context.id]['answerspan']">
                                        <div v-for="(value, key) of response[context.id]">
                                            <b>[[key]]</b> I don't know
                                        </div>
                                    </div>
                                    <div v-else>
                                        <div v-for="(value, key) of response[context.id]">
                                            <b>[[key]]</b>[[value]]
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-else-if="context.task === 'named entity recognition'" class="columns">
                            <div class="column is-two-thirds">
                                <div style="position: relative;">
                                    <h4>Sentence</h4>
                                    <div id="ner" ref="target" @select="showNamedEntity" disabled style="border:2px solid turquoise; position: absolute; z-index: 2;">[[JSON.parse(context.sentence).sentence]]</div>
                                    <div style="position: absolute; z-index: 1; border:2px solid turquoise;">
                                        <div v-if="context.id in response && response[context.id] === -1" v-bind:style="{'text-decoration': 'line-through', 'position': 'relative', 'z-index': 2}">[[JSON.parse(context.sentence).sentence]]</div>
                                        <div v-else-if="context.id in response" v-for="(type, index) in response[context.id]" v-bind:style="{'background-color': buttonColorMap[type], 'display': 'inline', 'position': 'relative', 'z-index': 1}">[[JSON.parse(context.sentence).token[index] ]]</div>    
                                    </div>
                                </div>
                                <br/>
                                <hr/>
                                <div v-if="isTranslation == 'tran'">
                                    [[context.sentence_trans]]
                                </div>
                            </div>
                            <div class="column">
                                <h4>Question</h4>
                                <div v-for="question in questions" v-if="question.task === context.task">
                                    [[question.text]]
                                    <br/>
                                    <div class="buttons">
                                        <button v-for="v in Object.keys(question.option)" :key="v" v-bind:style="{'background-color': buttonColorMap[v]}" @click="selectEntityType(v)" class="button">[[ question.option[v] ]]</button>
                                        <button @click="selectEntityType('O')" class="button">none (deselect)</button>
                                    </div>
                                    <button @click="selectEntityType(-1)" class="button is-danger"></i>I don't know</button>
                                </div>
                            </div>
                        </div>

                        <div v-else class="columns">
                            <div class="column is-two-thirds">
                                <h4>Sentence</h4>
                                <div v-for="(value, key) in JSON.parse(context.sentence)">
                                    <p>
                                        <b>[[key]]</b>
                                        [[value]]
                                    </p>
                                </div>
                                <hr/>
                                <div v-if="isTranslation == 'tran'">
                                    <div v-for="(value, key) of JSON.parse(context.sentence_trans)">
                                        <p>
                                            <b>[[key]]</b>
                                            [[value]]
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <h4>Question</h4>
                                <div v-for="question in questions" v-if="question.task === context.task">
                                    [[question.text]]
                                    <div class="buttons has-addons">
                                        <button :key="-1" class="button" :class="{ 'is-black': isValue(-1) }" @click="selectValue(-1)">I don't know</button>
                                        <button v-for="v in Object.keys(question.option)" :key="v" class="button"
                                        :class="{ 'is-black': isValue(v) }"
                                        @click="selectValue(v)">
                                        [[ question.option[v+''] ]]
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <div class="field is-grouped">
                        <p v-if="contextIndex > 0" class="control">
                            <button class="button is-warn" @click="contextIndex--">
                                ⇦ Previous
                            </button>
                        </p>
                        <p v-if="contextIndex < contexts.length - 1" class="control">
                            <button class="button is-success" @click="contextIndex++">
                                ⇨ Next
                            </button>
                        </p>
                        <p v-else-if="contextIndex === contexts.length - 1" class="control">
                            <button class="button is-success" @click="submit">
                                Submit
                            </button>
                        </p>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
<script>
    function loadValue(key) {
        skey = this.__uid__ + '::' + key;
        var value = localStorage.getItem(skey);
        if (value) {
            return JSON.parse(value);
        } else {
            return null;
        }
    }
    function saveValue(key, value) {
        skey = this.__uid__ + '::' + key;
        localStorage.setItem(skey, JSON.stringify(value));
    }
    this.__uid__ = loadValue('uid') || '{{ uid }}';
    this.__contexts__ = loadValue('contexts') || {{ contexts | tojson | safe }};
    this.__questions__ = loadValue('questions') || {{ questions | tojson | safe }};
    this.__validate_texts__ = {{ validate_texts | tojson | safe }};
    this.__workerId__ = loadValue('workerId') || '{{ workerId }}';
    this.__isTranslation__ = loadValue('isTranslation') || '{{ isTranslation }}';
    saveValue('uid', this.__uid__);
    saveValue('contexts', this.__contexts__);
    saveValue('questions', this.__questions__);
    Vue.use(VueMarkdown);
    var app = new Vue({
        el: '#task-view',
        delimiters: ['[[', ']]'],
        data: {
            uid: this.__uid__,
            contexts: this.__contexts__,
            questions: this.__questions__,
            workerId: this.__workerId__,
            contextIndex: loadValue('contextIndex') || 0,
            response: loadValue('response') || {},
            validateIndex: -1,
            validatorValue: -1,
            isTranslation: this.__isTranslation__,
            isHiddens: {},
            start_time: Date.now(),
            nerStartIndex: -1,
            nerEndIndex: -1,
            buttonColorMap: {'DAT': 'Salmon', 'EVT': 'Orange', 'FNB': 'Yellow', 'IND': 'GreenYellow', 'LOC': 'DarkKhaki', 'ORG': 'Aquamarine', 'PER': 'SkyBlue', 'QNT': 'Thistle', 'TIM': 'Silver'},
        },
        created() {
            this.validateIndex = Math.floor(Math.random() * 5);
            this.validatorValue = Math.floor(Math.random());
            this.contexts.forEach(c => {
                if (app.isTranslation == 'tran')
                    Vue.set(this.isHiddens, c.id, 1);
                else
                    Vue.set(this.isHiddens, c.id, 0);
            })
        },
        mounted() {
            ['mouseup', 'touchend'].forEach(event => {
                document.addEventListener(event, event => {
                    if (event.target === document.getElementById('mrc' || event.target.contains(document.getElementById('mrc'))))
                        this.selectAnswerspan();
                    else if (event.target === document.getElementById('ner') || event.target.contains(document.getElementById('ner')))
                        this.showNamedEntity();
                })
            });
        },
        methods: {
            updateTranslations(index) {
                Vue.set(this.isHiddens, index, this.isHiddens[index] + 1);
            },
            shuffle(array) {
                let currentIndex = array.length, temporaryValue, randomIndex;
                while(0 !== currentIndex) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex -= 1;
                    temporaryValue = array[currentIndex];
                    array[currentIndex] = array[randomIndex];
                    array[randomIndex] = temporaryValue;
                }
                return array;
            },            
            selectAnswerspan() {
                const context = this.contexts[this.contextIndex];
                if (!(context.id in this.response)) {
                    var contextResponse = {
                        'answerspan': null,
                        'answerstart': null
                    };
                    Vue.set(this.response, context.id, contextResponse);
                }
                // var txt = document.getElementById('mrc').innerText;
                var selection = window.getSelection();
                var start = selection.anchorOffset;
                var end = selection.focusOffset;
                this.response[context.id].answerstart = Math.min(start, end);
                this.response[context.id].answerspan = window.getSelection().toString();
            },
            showNamedEntity() {
                const context = this.contexts[this.contextIndex];
                if (!(context.id in this.response)) {
                    var contextResponse = Array(JSON.parse(context.sentence)["sentence"].length).fill('O');
                    Vue.set(this.response, context.id, contextResponse);
                }
                var selection = window.getSelection();
                var start = Math.min(selection.anchorOffset, selection.focusOffset);
                var end = Math.max(selection.anchorOffset, selection.focusOffset);
                this.nerStartIndex = start;
                this.nerEndIndex = end;
            },
            selectEntityType(type) {
                const context = this.contexts[this.contextIndex];
                if (type === -1){
                    Vue.set(this.response, context.id, -1);
                    return;
                }
                if (this.response[context.id] === -1){
                    var contextResponse = Array(JSON.parse(context.sentence)["sentence"].length).fill('O');
                    Vue.set(this.response, context.id, contextResponse);
                }
                if (window.getSelection().anchorNode.parentElement === document.getElementById('ner') && window.getSelection().focusNode.parentElement === document.getElementById('ner')){
                    for (var i = this.nerStartIndex; i < this.nerEndIndex; i++)
                    Vue.set(this.response[context.id], i, type);
                }
            },
            isValue(value) {
                const context = this.contexts[this.contextIndex];
                if (!this.response[context.id]) {
                    return false;
                }
                return this.response[context.id] === value;
            },
            selectValue(value) {
                const context = this.contexts[this.contextIndex];
                if (!(context.id in this.response)) {
                    var contextResponse = null;
                    Vue.set(this.response, context.id, contextResponse);
                }
                this.response[context.id] = value;
            },
            resetValues() {
                saveValue('uid', null);
                saveValue('contexts', null);
                saveValue('questions', null);
                saveValue('contextIndex', null);
                saveValue('response', null);
            },
            submit() {
                let isValid = true;
                this.contexts.forEach(context => {
                    if (!this.response[context.id]) {
                        isValid = false;
                    }
                    try {
                        Object.values(this.response[context.id]).forEach(cvalue => {
                            Object.values(cvalue).forEach(qvalue => {
                                if (qvalue === null) {
                                    isValid = false;
                                }
                            })
                        });
                    } catch (err) {
                        isValid = false;
                    }
                })
                if (!isValid) {
                    alert('You have to answer to all questions.');
                    return;
                }

                axios.post('/tasks/test', {
                    test_type: 'post',
                    isTranslation: this.isTranslation,
                    workerId: this.workerId,
                    uid: this.uid,
                    context_dicts: this.contexts,
                    questions: this.questions
                }).then(function(response) {
                    document.open()
                    document.write(response.data);
                }).catch(function (error) {
                    alert('Error occurred on draw: ' + error);
                });


                isPassed = true;
                axios.post('/tasks/submit', {
                    context: this.contexts,
                    response: this.response,
                    isPassed: isPassed,
                    uid: this.uid,
                    workerId: this.workerId,
                    start_time: this.start_time,
                    end_time: Date.now(),
                    translation: this.isHiddens
                }).then(response => {
                    const data = response.data;
                    const succeed = data.startsWith('done:');
                    if (succeed) {
                        this.resetValues();
                    } else {
                        alert('Error from server on submit: ' + response);
                    }
                }).catch(function (error) {
                    alert('Error occurred on submit: ' + error);
                });
            },
        },
        watch: {
            contextIndex() {
                saveValue('contextIndex', this.contextIndex);
                this.$nextTick(() => {
                    document.body.scrollTop = 0; // For Safari
                    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
                });
            },
            response() {
                saveValue('response', this.response);
            },
            isHiddens() {
                saveValue('isHiddens', this.isHiddens);
                this.$nextTick(() => {
                    document.body.scrollTop = 0; // For Safari
                    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
                });
            }
        }
    })
</script>
{% endblock %}